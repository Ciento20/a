<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>TV</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.8em%22 font-size=%2285%22>üì∫</text></svg>"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><style>
        /* Estilos para la Loader Bar */
        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: transparent;
            z-index: 10001;
            transition: opacity 0.4s ease;
        }

        .loader-bar {
            height: 100%;
            width: 30%;
            background: var(--accent-blue);
            box-shadow: 0 0 10px var(--accent-blue);
            animation: loading-slide 2s infinite ease-in-out;
        }

        @keyframes loading-slide {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        .loading-finished #loader-container {
            opacity: 0;
            pointer-events: none;
        }:root{--bg-color:#121212;--card-bg:#1e1e1e;--accent-blue:#448aff;--text-main:#ffffff;--text-muted:#888888;--channel-bg:#2a2a2a;--border-color:#333333;--nav-bg:#1a1a1a;--success:#06d6a0;--warning:var(--accent-blue)}body{background-color:var(--bg-color);color:var(--text-main);font-family:Inter,sans-serif;margin:0;padding:6px;padding-bottom:52px;display:flex;flex-direction:column;align-items:center}@keyframes blink-blue{0%{opacity:1;color:var(--accent-blue)}50%{opacity:.3;color:#fff}100%{opacity:1;color:var(--accent-blue)}}.is-live .time{animation:blink-blue 1s infinite;font-weight:800}.date-header{width:100%;text-align:center;margin:20px 0;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#efefef;left:0;right:0}.date-header::after,.date-header::before{content:"";flex:1;height:1px;background:var(--border-color);margin:0 10px}#events-container{width:95%;max-width:500px;display:flex;flex-direction:column;gap:18px;transition:max-width .3s ease}@media (min-width:768px){#events-container{max-width:600px}.date-header{max-width:100%}}@media (min-width:1200px){#events-container{max-width:800px;display:flex;flex-direction:column;gap:18px}.date-header{max-width:100%;margin:30px 0 10px 0}.event-card{border-bottom:1px solid #222;padding:10px 0}.event-card:last-child, .event-card:has(+ .date-header){border-bottom:none}}.event-card{display:flex;flex-direction:column;gap:8px;padding-bottom:8px;width:100%;border-bottom:1px solid #222}.event-card:last-child, .event-card:has(+ .date-header){border-bottom:none}.competicion-title{color:var(--accent-blue);font-size:.65rem;font-weight:600;display:flex;align-items:center;gap:4px}.competicion-title::before{content: "";font-size:.55rem}.event-info{display:flex;align-items:center;font-size:.75rem;font-weight:500;margin-bottom:2px}.time{font-size:.6rem;color:#fff;margin-right:5px;white-space:nowrap}.time-separator{color:var(--accent-blue);margin-right:6px;font-weight:700}.vs-container{display:flex;align-items:center;gap:6px;flex-wrap:wrap}.vs-text{color:var(--accent-blue);font-size:.55rem;font-weight:800;margin:0 1px}.team-logo{width:18px;height:18px;object-fit:contain;}.channels-wrapper{display:flex;flex-direction:row;overflow-x:auto;gap:12px;margin-top:6px;padding:4px 2px 12px 2px;scrollbar-width:none;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}.channels-wrapper::-webkit-scrollbar{display:none}.channels-wrapper::-webkit-scrollbar{height:4px}.channels-wrapper::-webkit-scrollbar-thumb{background:var(--accent-blue);border-radius:10px}.channel-button{position:relative;background:var(--channel-bg);color:var(--text-main);border-radius:10px;text-align:center;font-size:.65rem;font-weight:600;border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;flex:0 0 140px;height:78.75px;scroll-snap-align:start;overflow:hidden;padding:8px;cursor:pointer;transition:all .2s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 6px rgba(0,0,0,.3)}.channel-button:active{transform:scale(.95)}.channel-logo{width:80%;height:80%;object-fit:contain}.rating-badge{position:absolute;top:4px;left:4px;font-size:.5rem;color:var(--accent-blue);background:rgba(0,0,0,.6);padding:1px 4px;border-radius:4px;z-index:5}.btn-plus{position:absolute;bottom:0;right:0;width:40px;height:40px;background:transparent;color:transparent;display:flex;align-items:center;justify-content:center;z-index:10;cursor:pointer}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:2000}.modal-content{background:var(--card-bg);width:85%;max-width:280px;max-height:80vh;overflow-y:auto;border-radius:12px;padding:15px;border:1px solid var(--border-color)}.modal-title{margin-bottom:12px;font-size:.8rem;font-weight:700;text-align:center;color:var(--accent-blue)}.id-item{background:var(--channel-bg);padding:10px;margin-bottom:8px;border-radius:8px;font-size:.7rem;text-align:center;border:1px solid var(--border-color);cursor:pointer;display:flex;justify-content:space-between;align-items:center}.id-rating{color:var(--accent-blue);font-weight:700}.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:48px;background:var(--nav-bg);border-top:1px solid var(--border-color);display:flex;justify-content:space-around;align-items:center;z-index:1000}.nav-item{display:flex;flex-direction:column;align-items:center;color:var(--text-muted);text-decoration:none;font-size:.55rem;font-weight:600;gap:2px;flex:1;cursor:pointer}        .nav-item.active{color:var(--accent-blue)}.nav-icon{font-size:1rem}#status{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);font-size:.55rem;color:var(--accent-blue);background:rgba(0,0,0,.8);padding:4px 10px;border-radius:12px;z-index:100}
        /* Fuerza el ancho total en modo b√∫squeda */        #events-container.search-mode-active {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: wrap !important;
            justify-content: center !important;
            gap: 12px !important;
            padding: 10px !important;
            max-width: 100% !important;
        }

        #events-container.search-mode-active .channel-button {
            flex: 0 0 140px !important;
            width: 140px !important;
            height: 78.75px !important;
        }

        #events-container.search-mode-active .event-card {
            width: 100% !important;
        }
        </style></head><body>
    <div id="loader-container">
        <div class="loader-bar"></div>
    </div><div id="status">Iniciando motor...</div><div id="searchContainer" style="display:none;width:95%;max-width:500px;margin:10px auto;gap:8px;align-items:center"><input type="text" id="globalSearchInput" placeholder="Buscar canal, equipo o competici√≥n..." style="flex:1;padding:12px 16px;border-radius:12px;border:1px solid var(--border-color);background:var(--card-bg);color:#fff;font-size:.9rem;outline:0"></div><div id="events-container"></div>
<div id="noResultsContainer" class="no-results-container" style="display: none; text-align: center; padding: 40px; color: var(--text-muted);">
    <div class="no-results">
        <div class="no-results-icon" style="font-size: 3rem; margin-bottom: 10px;">üì°</div>
        <div class="no-results-text" style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">No se encontraron canales</div>
        <div class="no-results-hint" style="font-size: 0.85rem; margin-top: 5px; opacity: 0.8;">Prueba con otros filtros o t√©rminos de b√∫squeda</div>
    </div>
</div><div id="ids-modal" class="modal-overlay" onclick="UIManager.closeModal(event)"><div class="modal-content" onclick="event.stopPropagation()"><div id="modal-title" class="modal-title">Canales</div><div id="ids-list" class="ids-list"></div></div></div><nav class="bottom-nav"><div class="nav-item active" id="nav-home" onclick='UIManager.switchTab("home")'><span class="nav-icon">üóìÔ∏è</span><span>EVENTOS</span></div><div class="nav-item" id="nav-channels" onclick='UIManager.switchTab("channels")'><span class="nav-icon">üîç</span><span>BUSCAR</span></div></nav><script>const CONFIG = {
            BASE_URL: 'https://www.futbolenlatv.es',
            TARGET_URL: 'https://www.futbolenlatv.es/deporte',
            GIST_LOGOS: 'https://gist.githubusercontent.com/Ciento20/f7847e86d06e5011706fa76f2dab90be/raw/',
            PROXIES: [
                'https://api.allorigins.win/raw?url=',
                'https://api.codetabs.com/v1/proxy/?quest=',
                'https://corsproxy.io/?'
            ]
        };

        const STORAGE_CONFIG = {
            CACHE_KEY: 'ace_ids_cache',
            EXPIRATION_MS: 30 * 24 * 60 * 60 * 1000 // 30 d√≠as
        };        const RatingEngine = {
            DB_KEY: 'ace_autorating_v1',
            SESSION_KEY: 'ace_current_session',
            PENDING_KEY: 'ace_pending_penalty',
            interval: null,

            getDB() { return JSON.parse(localStorage.getItem(this.DB_KEY)) || {}; },
            getScore(id) { return this.getDB()[id] || 3.0; },

            saveScore(id, delta) {
                const db = this.getDB();
                db[id] = Math.max(1.0, Math.min(5.0, (db[id] || 3.0) + delta));
                localStorage.setItem(this.DB_KEY, JSON.stringify(db));
            },

            trackStart(id, channelName, index = 0) {
                this.stopRealTimeUpdate();
                this.processFocusReturn(channelName); 

                const sessionData = {
                    id: id, channelName: channelName, index: index,
                    start: Date.now(), lastProcessedMin: 0
                };
                localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
                this.startRealTimeUpdate();
            },            processFocusReturn(newChannelName) {
                const pending = JSON.parse(localStorage.getItem(this.PENDING_KEY));
                if (!pending) return;

                // Penalizaci√≥n de -1.5 si vuelve antes de 30 min al mismo canal
                const isExpired = (Date.now() - pending.timestamp) > 1800000; // 30 min
                const isDifferentChannel = pending.channelName !== newChannelName;

                if (isDifferentChannel || isExpired) {
                    localStorage.removeItem(this.PENDING_KEY);
                } else {
                    this.saveScore(pending.id, -1.5);
                    localStorage.removeItem(this.PENDING_KEY);
                }
            },

            checkPreviousSession() {
                const session = JSON.parse(localStorage.getItem(this.SESSION_KEY));
                if (!session) return;

                const durationSec = (Date.now() - session.start) / 1000;
                if (durationSec < 45) {
                    localStorage.setItem(this.PENDING_KEY, JSON.stringify({
                        id: session.id, 
                        channelName: session.channelName, 
                        timestamp: Date.now()
                    }));
                }
                localStorage.removeItem(this.SESSION_KEY);
                this.stopRealTimeUpdate();
            },            startRealTimeUpdate() {
                if (this.interval) clearInterval(this.interval);
                this.interval = setInterval(() => {
                    const session = JSON.parse(localStorage.getItem(this.SESSION_KEY));
                    if (!session) return this.stopRealTimeUpdate();
                    const min = (Date.now() - session.start) / 60000;
                    let delta = 0;

                    // Nueva l√≥gica de premios: Solo a partir de 30 min y cada 30 min extra
                    if (min >= 30 && (min - session.lastProcessedMin) >= 30) {
                        delta = 1.0;
                    }

                    if (delta > 0) {
                        this.saveScore(session.id, delta);
                        session.lastProcessedMin = Math.floor(min / 30) * 30;
                        localStorage.setItem(this.SESSION_KEY, JSON.stringify(session));
                    }
                }, 30000);
            },

            stopRealTimeUpdate() { if (this.interval) clearInterval(this.interval); }
        };

        const cleanChannelName = (name) => {
            if (!name) return "";
            let cleaned = name.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            if (cleaned.includes("LIGA DE CAMPEONES") && !cleaned.includes("M+")) {
                cleaned = cleaned.replace("LIGA DE CAMPEONES", "M+ LIGA DE CAMPEONES");
            }
            cleaned = cleaned.replace(/PLUS\+/g, "PLUS").replace(/\bMOVISTAR\b/g, "M+").replace(/\bLA LIGA\b/g, "LALIGA").replace(/\bHYPERMOTION\b/g, "LALIGA TV HYPERMOTION").replace(/\bBAR\b/gi, "").replace(/\b(HD|FHD|4K|1080P|720P)\b/gi, "").replace(/\*/g, "").replace(/\s+/g, " ").trim();
            if (cleaned.includes("DAZN LALIGA")) {
                cleaned = cleaned.replace(/\b1\b/g, "");
            }
            if (cleaned.includes("LALIGA TV HYPERMOTION") || cleaned === "HYPERMOTION") {
                cleaned = "LALIGA TV HYPERMOTION";
            }
            return cleaned.replace(/\s+/g, " ").trim();
        };

        const ComparisonEngine = {
            isMatch(nameA, nameB) {
                return cleanChannelName(nameA) === cleanChannelName(nameB);
            },
            normalizeText(text) {
                return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
            }
        };

        let channelLogosMap = JSON.parse(localStorage.getItem('logo_cache')) || {};
        let globalData = JSON.parse(localStorage.getItem('event_data_cache')) || [];
        let aceStreamMap = []; 
        let currentTab = 'home';        // Estado extendido para el buscador con mapeo de deportes
        const state = {
            tvCurrentFilter: 'all',
            tvSearchTerm: '',
            searchToEmoji: {
                'f1': 'üèéÔ∏è', 'formula 1': 'üèéÔ∏è', 'moto': 'üèçÔ∏è', 'motogp': 'üèçÔ∏è', 'motor': 'üèéÔ∏è',
                'futbol': '‚öΩ', 'soccer': '‚öΩ', 'balonpie': '‚öΩ',
                'tenis': 'üéæ', 'tennis': 'üéæ', 'rafa': 'üéæ',
                'basket': 'üèÄ', 'baloncesto': 'üèÄ', 'nba': 'üèÄ',
                'ufc': 'ü•ä', 'mma': 'ü•ä', 'boxeo': 'ü•ä',
                'ciclismo': 'üö¥', 'tour': 'üö¥', 'giro': 'üö¥'
            }
        };

        const NetworkService = {
            async fetchHtml(targetUrl) {
                const fetchPromises = CONFIG.PROXIES.map(proxy => 
                    fetch(`${proxy}${encodeURIComponent(targetUrl)}`)
                        .then(res => { if (!res.ok) throw new Error(); return res.text(); })
                );
                try { return await Promise.any(fetchPromises); } 
                catch (e) { throw new Error("Error de conexi√≥n"); }
            },
            async fetchLogos() {
                try {
                    const response = await fetch(CONFIG.GIST_LOGOS);
                    const text = await response.text();
                    const map = {};
                    text.split('\n').forEach(line => {
                        if (line.includes(': http')) {
                            const parts = line.split(': http');
                            const rawName = parts[0].trim();
                            map[cleanChannelName(rawName)] = 'http' + parts[1].trim();
                        }
                    });
                    return map;
                } catch (e) { return {}; }
            }
        };

        const AceStreamEngine = {
            SOURCES: [
                { id: 'ERA', url: 'https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/listaplana.txt', parser: 'parseEra' },
                { id: 'ELCANO', url: 'https://acestream-ids.vercel.app/', parser: 'parseElcano' }
            ],            // Funci√≥n simple de hashing para strings
            generateHash(str) {
                let hash = 5381, i = str.length;
                while(i) hash = (hash * 33) ^ str.charCodeAt(--i);
                return (hash >>> 0).toString(16);
            },

            async init() {
                let masterMap = new Map();
                const cache = JSON.parse(localStorage.getItem(STORAGE_CONFIG.CACHE_KEY)) || { hashes: {}, data: [] };
                const currentHashes = cache.hashes || {};
                let hasChanges = false;

                // Mapear datos previos para acceso r√°pido
                cache.data.forEach(item => masterMap.set(item.id, item));

                for (const src of this.SOURCES) {
                    try {
                        const raw = await NetworkService.fetchHtml(src.url);
                        const newHash = this.generateHash(raw);

                        if (currentHashes[src.id] === newHash) {
                            console.log(`[Hash] Fuente ${src.id} sin cambios. Saltando parseo.`);
                            continue;
                        }

                        console.log(`[Hash] Fuente ${src.id} ha cambiado. Procesando...`);
                        hasChanges = true;
                        currentHashes[src.id] = newHash;
                        
                        const parsed = src.parser === 'parseEra' ? this.parseEra(raw) : this.parseElcano(raw);
                        parsed.forEach(item => {
                            item.source = src.id === 'ELCANO' ? 'ELC' : 'ERA';
                            masterMap.set(item.id, item);
                        });
                    } catch (e) { console.warn(`Fuente ${src.id} fallida.`); }
                }

                const master = Array.from(masterMap.values());

                if (hasChanges && master.length > 0) {
                    this.saveToCache(master, currentHashes);
                } else if (master.length === 0) {
                    return this.loadFromCache();
                }
                return master;
            },            saveToCache(data, hashes = {}) {
                const cacheObj = { 
                    timestamp: Date.now(), 
                    data: data, 
                    hashes: hashes 
                };
                localStorage.setItem(STORAGE_CONFIG.CACHE_KEY, JSON.stringify(cacheObj));
            },
            loadFromCache() {
                const cached = localStorage.getItem(STORAGE_CONFIG.CACHE_KEY);
                if (!cached) return [];
                try {
                    const cacheObj = JSON.parse(cached);
                    const isExpired = (Date.now() - cacheObj.timestamp) > STORAGE_CONFIG.EXPIRATION_MS;
                    if (isExpired) console.warn("Cach√© expirada, pero se usa por falta de red.");
                    return cacheObj.data || [];
                } catch (e) { return []; }
            },
            parseEra(text) {
                const results = [];
                const lines = text.split('\n').filter(l => l.trim());
                for (let i = 0; i < lines.length; i += 2) {
                    const name = lines[i].split('-->')[0].trim();
                    const id = lines[i+1]?.trim().replace(/p$/, '');
                    if (id && id.length === 40) results.push({ name, id });
                }
                return results;
            },
            parseElcano(html) {
                const jsonMatch = html.match(/const links\s*=\s*(\[[\s\S]*?\]);/);
                if (!jsonMatch) return [];
                try {
                    return JSON.parse(jsonMatch[1])
                        .filter(l => l.url.includes('acestream://'))
                        .map(l => ({ 
                            name: l.name.trim(), 
                            id: l.url.split('://')[1] 
                        }));
                } catch (e) { return []; }
            }
        };

        const LiveEngine = {
            checkLive(event) {
                if (!event.fecha.toLowerCase().includes("hoy")) return false;
                const now = new Date();
                const [hrs, mins] = event.hora.split(':').map(Number);
                const startTime = new Date();
                startTime.setHours(hrs, mins, 0, 0);
                const endTime = new Date(startTime.getTime() + 120 * 60000);
                return now >= startTime && now <= endTime;
            }
        };

        const DataParser = {
            fixUrl(url) {
                if (!url || url.startsWith('http')) return url;
                return CONFIG.BASE_URL + (url.startsWith('/') ? '' : '/') + url;
            },
            parse(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const rows = doc.querySelectorAll('.tablaPrincipal tr');
                const results = [];
                let currentFecha = "";

                rows.forEach(row => {
                    if (row.classList.contains('cabeceraTabla')) {
                        currentFecha = row.textContent.trim();
                        return;
                    }
                    const hora = row.querySelector('.hora')?.textContent.trim();
                    if (!hora) return;

                    const compElem = row.querySelector('.detalles .ajusteDoslineas') || row.querySelector('.detalles label');
                    let competition = compElem?.title || compElem?.textContent || "Competici√≥n";
                    const sportConfig = {
                        '‚öΩ': ['LA LIGA', 'PREMIER', 'BUNDESLIGA', 'SERIE A', 'CHAMPIONS', 'EUROPA LEAGUE', 'FUTBOL', 'RECOPA', 'SAUDI PRO', 'LIGA F', 'FEDERACI√ìN', 'SUDAMERICANA', 'FUTSAL', 'ARGENTINA', 'LALIGA'],
                        'üèÄ': ['NBA', 'ENDESA', 'BASKET', 'EUROLIGA', 'BALONCESTO', 'FEB'],
                        'üèéÔ∏è': ['F√ìRMULA 1', 'F1', 'MOTOR', 'INDYCAR', 'NASCAR'],
                        'üèçÔ∏è': ['MOTOGP', 'MOTO2', 'MOTO3', 'SUPERBIKE', 'SUPERSPORT', 'MOTO'],
                        'üéæ': ['TENIS', 'DOHA', 'ATP', 'WTA', 'OPEN', 'RAFA', 'RIO DE JANEIRO', 'DELRAY', 'MASTERS 1000'],
                        'üö¥': ['CICLISMO', 'VUELTA', 'GIRO', 'TOUR', 'EMIRATOS'],
                        '‚õ≥': ['GOLF', 'LPGA', 'HONDA', 'KENYA', 'MASTERS'],
                        'ü§æ': ['ASOBAL', 'BALONMANO', 'AULA'],
                        'ü•ä': ['UFC', 'MMA', 'BOXEO', 'VELADA'],
                        'üõº': ['OK LIGA', 'HOCKEY'],
                        'üèâ': ['6 NACIONES', 'RUGBY']
                    };
                    const upperComp = competition.toUpperCase();
                    let emoji = "üèÜ";
                    Object.entries(sportConfig).some(([icon, keywords]) => {
                        if (keywords.some(key => upperComp.includes(key))) {
                            emoji = icon;
                            return true;
                        }
                    });
                    competition = emoji + " " + competition;
                    const canales = Array.from(row.querySelectorAll('.listaCanales li'))
                        .map(ch => ch.textContent.trim().split('(')[0].trim());

                    const local = row.querySelector('.local span');
                    const visitante = row.querySelector('.visitante span');
                    const localImg = row.querySelector('.local img');
                    const visitanteImg = row.querySelector('.visitante img');
                    const eventoUnico = row.querySelector('.eventoUnico');

                    let infoHtml = "";
                    if (local && visitante) {
                        infoHtml = `
                            <div class="vs-container">
                                <img src="${this.fixUrl(localImg?.src)}" style="width:18px;height:18px;object-fit:contain;" onerror="this.style.display='none'">
                                <span>${local.title || local.textContent}</span>
                                <span class="vs-text">VS</span>
                                <span>${visitante.title || visitante.textContent}</span>
                                <img src="${this.fixUrl(visitanteImg?.src)}" style="width:18px;height:18px;object-fit:contain;" onerror="this.style.display='none'">
                            </div>`;
                    } else if (eventoUnico) {
                        infoHtml = `<div class="vs-container"><span>${eventoUnico.innerText.trim()}</span></div>`;
                    }

                    results.push({ fecha: currentFecha, hora, competition, infoHtml, canales });
                });
                return results;
            }
        };

        const UIManager = {
            container: document.getElementById('events-container'),
            status: document.getElementById('status'),
            modal: document.getElementById('ids-modal'),
            lastClickTime: 0,

            switchTab(tab) {
                if (tab === 'home') {
                    const now = Date.now();
                    if (now - this.lastClickTime < 1000) {
                        this.setRandomColor();
                        this.lastClickTime = 0;
                        return;
                    }
                    this.lastClickTime = now;
                }
                currentTab = tab;
                const searchContainer = document.getElementById('searchContainer');
                
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.getElementById(`nav-${tab}`).classList.add('active');                if (tab === 'channels') {
                    searchContainer.style.display = 'flex';
                    this.container.classList.add('search-mode-active');
                    const input = document.getElementById('globalSearchInput');
                    input.addEventListener('input', (e) => {
                        state.tvSearchTerm = ComparisonEngine.normalizeText(e.target.value);
                        this.refresh();
                    });
                    input.focus();                } else {
                    searchContainer.style.display = 'none';
                    this.container.classList.remove('search-mode-active');
                    state.tvSearchTerm = '';
                }

                this.refresh();
                window.scrollTo(0,0);
            },            lastEventsHTML: '',
            refresh() {
                RatingEngine.checkPreviousSession(); 
                globalData.forEach(item => { item.isLive = LiveEngine.checkLive(item); });
                const processed = [...globalData].sort((a, b) => (a.isLive === b.isLive) ? 0 : a.isLive ? -1 : 1);
                
                if (currentTab === 'home') {
                    if (this.lastEventsHTML && state.tvSearchTerm === '') {
                        this.container.innerHTML = this.lastEventsHTML;
                    } else {
                        this.renderEvents(processed);
                    }
                } else {
                    this.renderUniqueChannels(processed);
                }
            },            renderEvents(data) {
                let htmlBuffer = "";
                let lastDate = "";
                
                data.forEach(item => {
                    // Filtrar canales con IDs y fusionar duplicados (BAR, etc.) usando el nombre limpio
                    const availableChannels = [];
                    const seen = new Set();
                    
                    item.canales.forEach(c => {
                        if (aceStreamMap.some(a => ComparisonEngine.isMatch(c, a.name))) {
                            const clean = cleanChannelName(c);
                            if (!seen.has(clean)) {
                                seen.add(clean);
                                availableChannels.push(c);
                            }
                        }
                    });

                    if (availableChannels.length === 0) return;                    if (item.fecha !== lastDate) {
                        htmlBuffer += `<div class="date-header">${item.fecha}</div>`;
                        lastDate = item.fecha;
                    }

                    htmlBuffer += `
                        <div class="event-card ${item.isLive ? 'is-live' : ''}">
                            <div class="competicion-title">${item.competition}</div>
                            <div class="event-info"><span class="time">${item.hora}</span><span class="time-separator">|</span>${item.infoHtml}</div>
                            <div class="channels-wrapper">${availableChannels.map(c => this.getChannelHtml(c)).join('')}</div>
                        </div>
                    `;
                });
                this.container.innerHTML = htmlBuffer;
                if (state.tvSearchTerm === '') this.lastEventsHTML = htmlBuffer;
            },            renderUniqueChannels(data) {
                const input = document.getElementById('globalSearchInput');
                const selectionStart = input.selectionStart;
                const selectionEnd = input.selectionEnd;
                const searchTerm = state.tvSearchTerm;
                this.container.innerHTML = "";

                if (searchTerm) {
                    const matchedEvents = data.filter(event => {
                        const textToSearch = ComparisonEngine.normalizeText(event.competition + event.infoHtml);
                        const hasEmojiMatch = Object.entries(state.searchToEmoji).some(([key, emoji]) => 
                            searchTerm.includes(key) && (event.competition.includes(emoji) || textToSearch.includes(key))
                        );
                        return textToSearch.includes(searchTerm) || hasEmojiMatch;
                    });

                    if (matchedEvents.length > 0) {
                        this.renderEvents(matchedEvents);
                        const divider = document.createElement('div');
                        divider.style.cssText = "width:100%; height:1px; background:#333; margin:20px 0; grid-column: 1/-1;";
                        this.container.appendChild(divider);
                    }
                }

                const uniqueMap = new Map();
                const filteredAceStreams = aceStreamMap.filter(ace => {
                    if (!searchTerm) return true;
                    const normalizedName = ComparisonEngine.normalizeText(ace.name);
                    const hasEmojiMatch = Object.entries(state.searchToEmoji).some(([key, emoji]) => 
                        searchTerm.includes(key) && (ace.name.includes(emoji) || normalizedName.includes(key))
                    );
                    return normalizedName.includes(searchTerm) || hasEmojiMatch;
                });

                filteredAceStreams.forEach(item => {
                    const clean = cleanChannelName(item.name);
                    if (!uniqueMap.has(clean)) uniqueMap.set(clean, item.name);
                });

                const noResults = document.getElementById('noResultsContainer');
                if (uniqueMap.size === 0 && this.container.children.length === 0) {
                    if (noResults) noResults.style.display = 'block';
                    return;
                } else {
                    if (noResults) noResults.style.display = 'none';
                }

                input.focus();
                input.setSelectionRange(selectionStart, selectionEnd);                const getPriority = (name) => {
                    const n = name.toUpperCase();
                    // Excluir canales internacionales de la prioridad alta
                    const isForeign = n.includes('(PL)') || n.includes('(DE)') || n.includes('(RU)');

                    if (n.includes('ELEVEN') || isForeign) return 4.1;
                    if (n.includes('DAZN')) return 1;
                    if (n.includes('M+') || n.includes('MOVISTAR') || n.includes('LIGA DE CAMPEONES')) return 2;
                    if (n.includes('EUROSPORT')) return 3;
                    
                    return 4.1;
                };

                const sortedChannels = Array.from(uniqueMap.values()).sort((a, b) => {
                    const pA = getPriority(a), pB = getPriority(b);
                    return pA !== pB ? pA - pB : cleanChannelName(a).localeCompare(cleanChannelName(b));
                });

                let lastP = Math.floor(getPriority(sortedChannels[0]));
                sortedChannels.forEach(channelName => {
                    const currentP = Math.floor(getPriority(channelName));
                    if (currentP !== lastP) {
                        const spacer = document.createElement('div');
                        spacer.style.cssText = 'width: 100%; height: 20px; grid-column: 1 / -1; display: block; clear: both;';
                        this.container.appendChild(spacer);
                        lastP = currentP;
                    }
                    this.container.insertAdjacentHTML('beforeend', this.getChannelHtml(channelName));
                });
            },            getChannelHtml(name) {
                const clean = cleanChannelName(name);
                const logoUrl = channelLogosMap[clean];
                const matching = aceStreamMap.filter(a => ComparisonEngine.isMatch(name, a.name));
                const pending = JSON.parse(localStorage.getItem(RatingEngine.PENDING_KEY));
                const getEffectiveScore = (id) => {
                    let s = RatingEngine.getScore(id);
                    if (pending && pending.id === id) s = Math.max(1.0, s - 1.5);
                    return s;
                };
                const bestIdObj = matching.sort((a, b) => getEffectiveScore(b.id) - getEffectiveScore(a.id))[0];
                const score = bestIdObj ? getEffectiveScore(bestIdObj.id) : null;
                const safeName = name.replace(/'/g, "\\'");
                
                let extraStyle = '';
                let badgeHtml = '';
                const upperName = name.toUpperCase();

                if (upperName.includes('BALONCESTO') && upperName.includes('DAZN')) {
                    badgeHtml = '<div style="position: absolute; right: 13%; top: 50%; transform: translateY(-50%); font-size: 40px; line-height: 1; z-index: 0; opacity: 1;">üèÄ</div>';
                }

                if (upperName.includes('VAMOS 2')) {
                    badgeHtml = '<div style="position: absolute; left: 28px; bottom: 12px; color: #1ec33c; font-weight: 900; font-size: 1.5rem; z-index: 2;">2</div>';
                }

                return `
                    <div class="channel-button" style="${extraStyle}" onclick="UIManager.playBestOrNext('${safeName}')">
                        
                        ${badgeHtml}
                        ${logoUrl ? `<img src="${logoUrl}" class="channel-logo" style="position:relative; z-index:2;" onerror="this.outerHTML='<span>${clean}</span>'">` : `<span style="position:relative; z-index:2;">${clean}</span>`}
                        ${bestIdObj ? `<div class="btn-plus" onclick="UIManager.openIdsModal(event, '${safeName}')">+</div>` : ''}
                    </div>`;
            },            playBestOrNext(channelName) {
                const matching = aceStreamMap
                    .filter(a => ComparisonEngine.isMatch(channelName, a.name))
                    .sort((a, b) => RatingEngine.getScore(b.id) - RatingEngine.getScore(a.id));

                if (matching.length === 0) return;

                const session = JSON.parse(localStorage.getItem(RatingEngine.SESSION_KEY));
                let nextIndex = 0;

                // Si re-clickea el mismo canal en menos de 30 segundos, penalizamos el anterior y saltamos al siguiente
                if (session && session.channelName === channelName && (Date.now() - session.start) < 30000) {
                    RatingEngine.saveScore(session.id, -2.0); // Penalizaci√≥n extra por fallo inmediato
                    nextIndex = (session.index + 1) % matching.length;
                }

                const target = matching[nextIndex];
                RatingEngine.trackStart(target.id, channelName, nextIndex);
                window.location.href = `acestream://${target.id}`;
            },

            openIdsModal(event, channelName) {
                event.stopPropagation();
                const list = document.getElementById('ids-list');
                const title = document.getElementById('modal-title');
                
                const matching = aceStreamMap
                    .filter(a => ComparisonEngine.isMatch(channelName, a.name))
                    .sort((a, b) => RatingEngine.getScore(b.id) - RatingEngine.getScore(a.id));

                title.textContent = cleanChannelName(channelName);
                list.innerHTML = "";
                
                matching.forEach((item, i) => {
                    let currentRating = RatingEngine.getScore(item.id);
                    const pending = JSON.parse(localStorage.getItem(RatingEngine.PENDING_KEY));
                    if (pending && pending.id === item.id) {
                        currentRating = Math.max(1.0, currentRating - 1.5);
                    }
                    const btn = document.createElement('div');
                    btn.className = 'id-item';
                    btn.innerHTML = `
                        <span style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            <small style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.55rem; font-weight: 700; color: var(--accent-blue); border: 1px solid rgba(68, 138, 255, 0.3); min-width: 32px; text-align: center;">${item.source || 'ID'}</small>
                            <span style="font-family: monospace; opacity: 0.9;">${item.id.substring(0, 10).toUpperCase()}</span>
                        </span>
                        <span class="id-rating">‚òÖ ${currentRating.toFixed(1)}</span>
                    `;
                    btn.onclick = () => {
                        RatingEngine.trackStart(item.id, channelName, i);
                        window.location.href = `acestream://${item.id}`;
                    };
                    list.appendChild(btn);
                });
                this.modal.style.display = 'flex';
            },            closeModal() { this.modal.style.display = 'none'; },

            setRandomColor() {
                const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                document.documentElement.style.setProperty('--accent-blue', randomColor);
                localStorage.setItem('custom_accent_color', randomColor);
            }
        };        async function init() {
            const savedColor = localStorage.getItem('custom_accent_color');
            if (savedColor) document.documentElement.style.setProperty('--accent-blue', savedColor);
            window.addEventListener('focus', () => RatingEngine.checkPreviousSession());

            // 1. RENDERIZADO INSTANT√ÅNEO DESDE CACH√â
            // Cargamos IDs guardados para completar el mapa
            aceStreamMap = AceStreamEngine.loadFromCache();
            
            // Si hay datos previos, refrescamos la UI de inmediato
            if (globalData.length > 0 || aceStreamMap.length > 0) {
                UIManager.refresh();
                // Ocultamos solo el texto de estado, pero NO a√±adimos 'loading-finished'
                // para que la barra de carga superior siga visible hasta que termine la red
                UIManager.status.style.display = 'none';
            }

            try {
                // 2. CARGA DE RED EN SEGUNDO PLANO
                const [logos, html] = await Promise.all([
                    NetworkService.fetchLogos(), 
                    NetworkService.fetchHtml(CONFIG.TARGET_URL)
                ]);
                
                // Actualizamos logos en memoria y cach√©
                if (logos && Object.keys(logos).length > 0) {
                    channelLogosMap = logos;
                    localStorage.setItem('logo_cache', JSON.stringify(logos));
                }

                // Parseamos y guardamos nuevos eventos
                const freshData = DataParser.parse(html);
                if (freshData && freshData.length > 0) {
                    globalData = freshData;
                    localStorage.setItem('event_data_cache', JSON.stringify(freshData));
                }

                // Actualizamos IDs de fuentes externas
                aceStreamMap = await AceStreamEngine.init();
                
                // 3. FINALIZACI√ìN Y OCULTAR BARRA DE CARGA
                UIManager.refresh();
                setInterval(UIManager.refresh, 60000);
                UIManager.status.style.display = 'none';
                document.body.classList.add('loading-finished'); 
            } catch (err) {
                console.error("Error en carga real:", err);
                document.body.classList.add('loading-finished');
                if (globalData.length === 0) {
                    UIManager.status.style.display = 'block';
                    UIManager.status.textContent = "Error de red. Usando cach√©.";
                }
            }
        }

        init();</script></body></html>